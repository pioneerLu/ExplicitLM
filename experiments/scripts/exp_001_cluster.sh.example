#!/bin/bash
################################################################################
# 实验001 - 集群模式统一脚本
#
# 用法：
#   ./exp_001_cluster.sh pre    # 登陆节点：前置工作（数据同步）
#   ./exp_001_cluster.sh train  # 计算节点：训练
#   ./exp_001_cluster.sh post   # 登陆节点：后续工作（Git提交）
################################################################################

# ============================================================================
# 实验配置（只需在这里修改一次）
# ============================================================================
EXP_ID="exp_001"
EXP_DESC="基线实验 knowledge_num=1M epochs=10"

# 数据版本
DATASET_VERSION=""
VAL_DATASET_VERSION=""
EMBEDDING_VERSION=""
DATABASE_VERSION=""
CACHE_VERSION=""

# 训练参数
TRAIN_ARGS="--epochs 10 --knowledge_num 1048576 --dim 512 --n_layers 8 --batch_size 1 --learning_rate 2e-4"

# ============================================================================
# 执行阶段选择
# ============================================================================
STAGE="${1:-pre}"  # 默认为pre阶段

case "$STAGE" in
    pre)
        echo "执行前置阶段（登陆节点）..."
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        source "${SCRIPT_DIR}/_run_experiment_cluster_pre.sh"
        ;;
    train)
        echo "执行训练阶段（计算节点）..."
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        source "${SCRIPT_DIR}/_run_experiment_cluster_train.sh"
        ;;
    post)
        echo "执行后续阶段（登陆节点）..."
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        source "${SCRIPT_DIR}/_run_experiment_cluster_post.sh"
        ;;
    *)
        echo "错误：未知阶段 '$STAGE'"
        echo ""
        echo "用法："
        echo "  $0 pre    - 登陆节点：数据同步和准备"
        echo "  $0 train  - 计算节点：执行训练"
        echo "  $0 post   - 登陆节点：DVC追踪和Git提交"
        exit 1
        ;;
esac
